package rabbitmq.demos.fanout;

import java.io.IOException;
import java.util.concurrent.TimeoutException;

import com.rabbitmq.client.Channel;
import com.rabbitmq.client.Connection;
import com.rabbitmq.client.ConnectionFactory;

public class FanoutPublisher {

	public static void main(String[] args) throws IOException, TimeoutException {
		ConnectionFactory factory = new ConnectionFactory();
		factory.setHost("localhost");
		factory.setVirtualHost("/");
		factory.setPort(5672);
        factory.setUsername("guest");
        factory.setPassword("guest");
		
        
        Connection conn = factory.newConnection();
        Channel channel = conn.createChannel();

        channel.ExchangeDeclare(
            "ex.fanout",
            ExchangeType.Fanout,
            true,
            false,
            null);

        channel.QueueDeclare(
            "my.queue1",
            true,
            false,
            false,
            null);

        channel.QueueDeclare(
            "my.queue2",
            true,
            false,
            false,
            null);

        channel.QueueBind("my.queue1", "ex.fanout", "");
        channel.QueueBind("my.queue2", "ex.fanout", "");

        channel.BasicPublish(
            "ex.fanout",
            "",
            null,
            Encoding.UTF8.GetBytes("Message 1")
            );

        channel.BasicPublish(
            "ex.fanout",
            "",
            null,
            Encoding.UTF8.GetBytes("Message 2")
            );

        Console.WriteLine("Press a key to exit.");
        Console.ReadKey();

        channel.QueueDelete("my.queue1");
        channel.QueueDelete("my.queue2");
        channel.ExchangeDelete("ex.fanout");

        channel.close();
        conn.close();
        
		Connection connection = factory.newConnection();
		Channel channel = connection.createChannel();
		
		channel.queueDeclare("my.queue1", false, false, false, null);
		String message = "Hello World!";
		channel.basicPublish("", "my.queue1", null, message.getBytes());
		
		System.out.println(" [x] Sent '" + message + "'");

	}

}
